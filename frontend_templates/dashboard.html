<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application Dashboard - Steve Glen</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/unified-theme.css" rel="stylesheet">
    <style>
        .stat-card {
            background: var(--bs-dark);
            border: 1px solid var(--bs-gray-700);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            border-color: var(--bs-primary);
            transform: translateY(-2px);
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--bs-primary);
            margin: 0;
        }
        .stat-label {
            color: var(--bs-gray-300);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        .document-link {
            color: var(--bs-primary);
            text-decoration: none;
            font-weight: 500;
        }
        .document-link:hover {
            color: var(--bs-primary);
            text-decoration: underline;
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
        }
        .table-dark {
            --bs-table-bg: var(--bs-dark);
        }
        .login-container {
            max-width: 400px;
            margin: 5rem auto;
            padding: 2rem;
            background: var(--bs-dark);
            border-radius: 10px;
            border: 1px solid var(--bs-gray-700);
        }
        .brand-logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--bs-primary);
            text-align: center;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body class="bg-dark text-light">
    <!-- Login Screen -->
    <div id="loginScreen" class="container-fluid">
        <div class="login-container">
            <div class="brand-logo">
                <i class="fas fa-briefcase me-2"></i>
                Job Application Dashboard
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="password" required>
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                            <i class="fas fa-eye" id="passwordIcon"></i>
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-100">Access Dashboard</button>
            </form>
            <div id="loginError" class="alert alert-danger mt-3" style="display: none;"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display: none;">
        <!-- Navigation -->
        <nav class="navbar navbar-dark bg-dark border-bottom">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">
                    <i class="fas fa-briefcase me-2"></i>
                    Job Application Dashboard
                </span>
                <div class="navbar-nav ms-auto">
                    <a href="/workflow" class="btn btn-outline-info btn-sm me-2">
                        <i class="fas fa-project-diagram me-1"></i>Workflow
                    </a>
                    <a href="/database-schema" class="btn btn-outline-success btn-sm me-2">
                        <i class="fas fa-database me-1"></i>Schema
                    </a>
                    <a href="/tone-analysis" class="btn btn-outline-warning btn-sm me-2">
                        <i class="fas fa-chart-line me-1"></i>Tone Analysis
                    </a>
                    <a href="/preferences" class="btn btn-outline-primary btn-sm me-2">
                        <i class="fas fa-cogs me-1"></i>Preferences
                    </a>
                    <a href="/job-override" class="btn btn-outline-danger btn-sm me-2">
                        <i class="fas fa-edit me-1"></i>Job Override
                    </a>
                    <span class="navbar-text me-3">Welcome, Steve Glen</span>
                    <button class="btn btn-outline-secondary btn-sm" id="logoutBtn">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid py-4">

            
            <!-- Stats Overview -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h3 class="stat-value" id="scrapes24h">-</h3>
                                <p class="stat-label">Scrapes (24h)</p>
                            </div>
                            <i class="fas fa-search fa-2x text-primary opacity-50"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h3 class="stat-value" id="scrapesWeek">-</h3>
                                <p class="stat-label">Scrapes (Week)</p>
                            </div>
                            <i class="fas fa-calendar-week fa-2x text-primary opacity-50"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h3 class="stat-value" id="applications24h">-</h3>
                                <p class="stat-label">Applications (24h)</p>
                            </div>
                            <i class="fas fa-paper-plane fa-2x text-primary opacity-50"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h3 class="stat-value" id="applicationsWeek">-</h3>
                                <p class="stat-label">Applications (Week)</p>
                            </div>
                            <i class="fas fa-chart-line fa-2x text-primary opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Applications -->
            <div class="row">
                <div class="col-12">
                    <div class="card bg-dark border-secondary">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-file-alt me-2"></i>
                                Recent Applications
                            </h5>
                            <button class="btn btn-primary btn-sm" onclick="refreshData()">
                                <i class="fas fa-sync-alt me-1"></i>Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="loadingIndicator" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="mt-2">Loading applications...</div>
                            </div>
                            <div id="applicationsTable" style="display: none;">
                                <div class="table-responsive">
                                    <table class="table table-compact table-dark table-striped">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Job Title</th>
                                                <th>Company</th>
                                                <th>Status</th>
                                                <th>Documents</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="applicationsBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="noApplications" class="text-center py-4" style="display: none;">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No applications found</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card bg-dark border-secondary">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-cog me-2"></i>
                                System Status
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Database</span>
                                <span class="badge bg-success" id="dbStatus">Connected</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Document Storage</span>
                                <span class="badge bg-success" id="storageStatus">Available</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Last Update</span>
                                <span class="text-muted" id="lastUpdate">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-dark border-secondary">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>
                                Quick Stats
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Success Rate</span>
                                <span class="text-success" id="successRate">-</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Avg. Response Time</span>
                                <span class="text-info" id="avgResponseTime">-</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Total Jobs Tracked</span>
                                <span class="text-primary" id="totalJobs">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gemini API Usage Tracking -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card bg-dark border-secondary">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-brain me-2"></i>
                                Gemini AI Usage Tracking
                                <span class="badge bg-primary ms-2" id="currentModel">-</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-info mb-3">Daily Usage (Free Tier)</h6>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span>Requests Used</span>
                                            <span id="dailyRequestsUsed">-</span>
                                        </div>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" id="dailyRequestsProgress" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted">Daily limit: <span id="dailyRequestLimit">1,500</span> requests</small>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="d-flex justify-content-between">
                                                <span>Cost Today:</span>
                                                <span class="text-success" id="dailyCost">$0.00</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="d-flex justify-content-between">
                                                <span>RPM Limit:</span>
                                                <span class="text-info" id="rpmLimit">15</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-warning mb-3">Monthly Projection (Free Tier)</h6>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span>Monthly Requests</span>
                                            <span id="monthlyRequestsUsed">-</span>
                                        </div>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" role="progressbar" id="monthlyRequestsProgress" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted">Monthly est.: <span id="monthlyRequestLimit">45,000</span> requests</small>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="d-flex justify-content-between">
                                                <span>Cost Month:</span>
                                                <span class="text-success" id="monthlyCost">FREE</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="d-flex justify-content-between">
                                                <span>Model Switches:</span>
                                                <span class="text-danger" id="modelSwitches">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h6 class="text-secondary mb-3">Usage Recommendations</h6>
                                    <div id="usageRecommendations" class="alert alert-info">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Loading usage recommendations...
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <div class="card bg-secondary border-0">
                                        <div class="card-body text-center">
                                            <h6 class="text-primary">Gemini 2.0 Flash</h6>
                                            <p class="mb-1">$0.00075/1K tokens</p>
                                            <small class="text-muted">Primary Model</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-secondary border-0">
                                        <div class="card-body text-center">
                                            <h6 class="text-success">Gemini 2.0 Flash Lite</h6>
                                            <p class="mb-1">$0.0003/1K tokens</p>
                                            <small class="text-muted">Fallback Model</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-secondary border-0">
                                        <div class="card-body text-center">
                                            <h6 class="text-info">Potential Savings</h6>
                                            <p class="mb-1" id="potentialSavings">$0.00</p>
                                            <small class="text-muted">Monthly (if using Lite)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Model Comparison Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-brain"></i> AI Model Comparison
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card bg-dark border-success">
                                        <div class="card-body">
                                            <h6 class="text-success">Gemini 2.0 Flash <span class="badge bg-success">Current</span></h6>
                                            <p class="text-muted small">Latest multimodal model</p>
                                            <div class="d-flex justify-content-between">
                                                <span>Cost:</span>
                                                <span class="text-success">FREE</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Tier:</span>
                                                <span class="text-success">Free</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Limits:</span>
                                                <span class="text-success">1.5K/day</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-dark border-warning">
                                        <div class="card-body">
                                            <h6 class="text-warning">Gemini 2.5 Flash <span class="badge bg-warning">Premium</span></h6>
                                            <p class="text-muted small">Enhanced reasoning & accuracy</p>
                                            <div class="d-flex justify-content-between">
                                                <span>Input:</span>
                                                <span class="text-warning">$0.30/1M</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Output:</span>
                                                <span class="text-warning">$2.50/1M</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Tier:</span>
                                                <span class="text-warning">Paid</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-dark border-info">
                                        <div class="card-body">
                                            <h6 class="text-info">Gemini 2.0 Flash Lite <span class="badge bg-info">Backup</span></h6>
                                            <p class="text-muted small">Lightweight & efficient</p>
                                            <div class="d-flex justify-content-between">
                                                <span>Cost:</span>
                                                <span class="text-success">FREE</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Tier:</span>
                                                <span class="text-success">Free</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Speed:</span>
                                                <span class="text-info">Faster</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Current Setup:</strong> Using free tier Gemini 2.0 Flash with automatic fallback to Lite version for cost optimization.
                                        Upgrade to Gemini 2.5 Flash for enhanced reasoning capabilities.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ============= SECURITY FUNCTIONS =============
        
        /**
         * Sanitize text input to prevent XSS attacks
         * @param {string} text - The text to sanitize
         * @returns {string} - Sanitized text
         */
        function sanitizeText(text) {
            if (typeof text !== 'string') return '';
            
            // Create a temporary div to safely escape HTML
            const tempDiv = document.createElement('div');
            tempDiv.textContent = text;
            return tempDiv.innerHTML;
        }
        
        /**
         * Validate and sanitize URLs to prevent malicious redirects
         * @param {string} url - The URL to validate
         * @returns {string} - Sanitized URL or empty string if invalid
         */
        function sanitizeUrl(url) {
            if (typeof url !== 'string') return '';
            
            try {
                const parsedUrl = new URL(url, window.location.origin);
                
                // Allow only http, https, and relative URLs
                if (parsedUrl.protocol === 'http:' || parsedUrl.protocol === 'https:') {
                    return parsedUrl.toString();
                }
                
                // Block dangerous protocols
                if (parsedUrl.protocol === 'javascript:' || 
                    parsedUrl.protocol === 'data:' || 
                    parsedUrl.protocol === 'vbscript:') {
                    return '';
                }
                
                return parsedUrl.toString();
            } catch (e) {
                return '';
            }
        }
        
        /**
         * Validate input against common injection patterns
         * @param {string} input - The input to validate
         * @returns {boolean} - True if input appears safe
         */
        function validateInput(input) {
            if (typeof input !== 'string') return false;
            
            // Check for common injection patterns
            const dangerousPatterns = [
                /<script[^>]*>.*?<\/script>/gi,
                /javascript:/gi,
                /on\w+\s*=/gi,
                /eval\s*\(/gi,
                /expression\s*\(/gi
            ];
            
            return !dangerousPatterns.some(pattern => pattern.test(input));
        }
        
        /**
         * Secure API request with authentication check
         * @param {string} url - The API endpoint URL
         * @param {object} options - Fetch options
         * @returns {Promise} - Fetch promise with security headers
         */
        async function secureApiRequest(url, options = {}) {
            // Add security headers
            const secureOptions = {
                ...options,
                credentials: 'same-origin', // Include cookies for session
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest', // CSRF protection
                    ...(options.headers || {})
                }
            };
            
            return fetch(url, secureOptions);
        }
        
        // ============= END SECURITY FUNCTIONS =============
        
        // Check authentication status on load
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuthenticationStatus();
        });

        // Password toggle functionality
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordField = document.getElementById('password');
            const passwordIcon = document.getElementById('passwordIcon');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                passwordIcon.classList.remove('fa-eye');
                passwordIcon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                passwordIcon.classList.remove('fa-eye-slash');
                passwordIcon.classList.add('fa-eye');
            }
        });

        // New authentication function to check server-side auth status
        async function checkAuthenticationStatus() {
            try {
                const response = await fetch('/api/dashboard/stats');
                if (response.status === 401) {
                    showLogin();
                } else if (response.ok) {
                    showDashboard();
                } else {
                    showLogin();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                showLogin();
            }
        }

        // Secure login form handler using server-side authentication
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // Show loading state
            submitBtn.disabled = true;
            // Clear button content securely and add loading state
            submitBtn.textContent = '';
            const spinner = document.createElement('i');
            spinner.className = 'fas fa-spinner fa-spin me-2';
            submitBtn.appendChild(spinner);
            submitBtn.appendChild(document.createTextNode('Authenticating...'));
            
            try {
                const response = await fetch('/dashboard/authenticate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: password })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Authentication successful
                    showDashboard();
                } else {
                    showLoginError(result.message || 'Invalid password');
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showLoginError('Authentication failed. Please try again.');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Secure logout handler
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                await fetch('/dashboard/logout', { method: 'POST' });
            } catch (error) {
                console.error('Logout error:', error);
            }
            showLogin();
        });

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadDashboardData();
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('password').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Dashboard data loading
        async function loadDashboardData() {
            try {
                // Load stats
                const response = await fetch('/api/dashboard/stats');
                const data = await response.json();
                
                document.getElementById('scrapes24h').textContent = data.scrapes_24h || 0;
                document.getElementById('scrapesWeek').textContent = data.scrapes_week || 0;
                document.getElementById('applications24h').textContent = data.applications_24h || 0;
                document.getElementById('applicationsWeek').textContent = data.applications_week || 0;
                document.getElementById('successRate').textContent = data.success_rate || '-';
                document.getElementById('avgResponseTime').textContent = data.avg_response_time || '-';
                document.getElementById('totalJobs').textContent = data.total_jobs || 0;
                
                // Load applications
                await loadApplications();
                
                // Load Gemini usage stats
                await loadGeminiUsage();
                
                // Update last update time
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                
                // Update system status to show success
                updateSystemStatus();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showSystemError();
            }
        }

        async function loadApplications() {
            try {
                const response = await fetch('/api/dashboard/applications');
                const applications = await response.json();
                
                const tbody = document.getElementById('applicationsBody');
                const loadingIndicator = document.getElementById('loadingIndicator');
                const applicationsTable = document.getElementById('applicationsTable');
                const noApplications = document.getElementById('noApplications');
                
                loadingIndicator.style.display = 'none';
                
                if (applications.length === 0) {
                    noApplications.style.display = 'block';
                    applicationsTable.style.display = 'none';
                } else {
                    // Clear existing content securely
                    tbody.textContent = '';
                    
                    // Create table rows securely without innerHTML to prevent XSS
                    applications.forEach(app => {
                        const row = document.createElement('tr');
                        
                        // Date column
                        const dateCell = document.createElement('td');
                        dateCell.textContent = new Date(app.created_at).toLocaleDateString();
                        row.appendChild(dateCell);
                        
                        // Job title column (sanitized)
                        const titleCell = document.createElement('td');
                        titleCell.textContent = sanitizeText(app.job_title) || 'Unknown';
                        row.appendChild(titleCell);
                        
                        // Company column (sanitized)
                        const companyCell = document.createElement('td');
                        companyCell.textContent = sanitizeText(app.company_name) || 'Unknown';
                        row.appendChild(companyCell);
                        
                        // Status column
                        const statusCell = document.createElement('td');
                        const statusBadge = document.createElement('span');
                        statusBadge.className = `badge ${getStatusBadgeClass(app.status)} status-badge`;
                        statusBadge.textContent = sanitizeText(app.status);
                        statusCell.appendChild(statusBadge);
                        row.appendChild(statusCell);
                        
                        // Documents column - create links securely
                        const docsCell = document.createElement('td');
                        if (app.resume_url) {
                            const resumeLink = document.createElement('a');
                            resumeLink.href = sanitizeUrl(app.resume_url);
                            resumeLink.className = 'document-link me-2';
                            resumeLink.target = '_blank';
                            resumeLink.rel = 'noopener noreferrer'; // Security: prevent window.opener access
                            resumeLink.textContent = 'Resume';
                            docsCell.appendChild(resumeLink);
                        }
                        if (app.cover_letter_url) {
                            const coverLink = document.createElement('a');
                            coverLink.href = sanitizeUrl(app.cover_letter_url);
                            coverLink.className = 'document-link';
                            coverLink.target = '_blank';
                            coverLink.rel = 'noopener noreferrer'; // Security: prevent window.opener access
                            coverLink.textContent = 'Cover Letter';
                            docsCell.appendChild(coverLink);
                        }
                        row.appendChild(docsCell);
                        
                        // Actions column
                        const actionsCell = document.createElement('td');
                        const viewBtn = document.createElement('button');
                        viewBtn.className = 'btn btn-sm btn-outline-primary';
                        viewBtn.setAttribute('data-app-id', sanitizeText(app.id));
                        viewBtn.addEventListener('click', () => viewApplication(sanitizeText(app.id)));
                        
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-eye';
                        viewBtn.appendChild(icon);
                        actionsCell.appendChild(viewBtn);
                        row.appendChild(actionsCell);
                        
                        tbody.appendChild(row);
                    });
                    
                    applicationsTable.style.display = 'block';
                    noApplications.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading applications:', error);
                showSystemError();
            }
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'sent': return 'bg-success';
                case 'pending': return 'bg-warning';
                case 'failed': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function showSystemError() {
            document.getElementById('dbStatus').textContent = 'Error';
            document.getElementById('dbStatus').className = 'badge bg-danger';
            document.getElementById('storageStatus').textContent = 'Error';
            document.getElementById('storageStatus').className = 'badge bg-danger';
        }

        function updateSystemStatus() {
            // Update system status based on successful API calls
            document.getElementById('dbStatus').textContent = 'Connected';
            document.getElementById('dbStatus').className = 'badge bg-success';
            document.getElementById('storageStatus').textContent = 'Available';
            document.getElementById('storageStatus').className = 'badge bg-success';
        }

        function refreshData() {
            loadDashboardData();
        }

        function viewApplication(appId) {
            // Future implementation for viewing application details
            console.log('View application:', appId);
        }

        // Load Gemini usage statistics
        async function loadGeminiUsage() {
            try {
                const response = await fetch('/api/ai/gemini-usage');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const usage = data.real_time_usage;
                    const analysis = data.today_analysis_stats;
                    
                    // Update model badge - show model name instead of just ID
                    const modelName = usage.current_model_info?.name || usage.current_model || 'Loading...';
                    document.getElementById('currentModel').textContent = modelName;
                    document.getElementById('currentModel').className = `badge ms-2 ${usage.current_model?.includes('lite') ? 'bg-success' : 'bg-primary'}`;
                    
                    // Update daily usage (requests for free tier)
                    document.getElementById('dailyRequestsUsed').textContent = formatNumber(usage.daily_requests_used || 0);
                    document.getElementById('dailyRequestLimit').textContent = formatNumber(usage.daily_request_limit || 1500);
                    document.getElementById('dailyCost').textContent = usage.tier === 'free' ? 'FREE' : `$${(usage.daily_cost || 0).toFixed(4)}`;
                    document.getElementById('rpmLimit').textContent = usage.requests_per_minute_limit || 15;
                    
                    // Update daily progress bar (requests)
                    const dailyRequestsProgress = document.getElementById('dailyRequestsProgress');
                    const dailyRequestsPercentage = ((usage.daily_requests_used || 0) / (usage.daily_request_limit || 1500)) * 100;
                    dailyRequestsProgress.style.width = `${Math.min(dailyRequestsPercentage, 100)}%`;
                    dailyRequestsProgress.className = `progress-bar ${getUsageProgressClass(dailyRequestsPercentage)}`;
                    
                    // Update monthly usage (requests for free tier)
                    document.getElementById('monthlyRequestsUsed').textContent = formatNumber(usage.monthly_requests_used || 0);
                    document.getElementById('monthlyRequestLimit').textContent = formatNumber(usage.monthly_request_limit || 45000);
                    document.getElementById('monthlyCost').textContent = usage.tier === 'free' ? 'FREE' : `$${(usage.monthly_cost || 0).toFixed(4)}`;
                    document.getElementById('modelSwitches').textContent = usage.model_switches || 0;
                    
                    // Update monthly progress bar (requests)
                    const monthlyRequestsProgress = document.getElementById('monthlyRequestsProgress');
                    const monthlyRequestsPercentage = ((usage.monthly_requests_used || 0) / (usage.monthly_request_limit || 45000)) * 100;
                    monthlyRequestsProgress.style.width = `${Math.min(monthlyRequestsPercentage, 100)}%`;
                    monthlyRequestsProgress.className = `progress-bar bg-warning ${monthlyRequestsPercentage > 80 ? 'bg-danger' : ''}`;
                    
                    // Update potential savings (always $0 for free tier)
                    document.getElementById('potentialSavings').textContent = usage.tier === 'free' ? '$0.00' : `$${(data.cost_comparison?.potential_monthly_savings || 0).toFixed(4)}`;
                    
                    // Update recommendations (XSS-safe)
                    const recommendationsDiv = document.getElementById('usageRecommendations');
                    if (data.recommendations && data.recommendations.length > 0) {
                        // Clear existing content securely
                        recommendationsDiv.textContent = '';
                        
                        // Safely add each recommendation
                        data.recommendations.forEach(rec => {
                            const recDiv = document.createElement('div');
                            recDiv.className = 'mb-1';
                            recDiv.textContent = rec; // Safe text assignment
                            recommendationsDiv.appendChild(recDiv);
                        });
                        
                        recommendationsDiv.className = getRecommendationClass(data.recommendations[0]);
                    } else {
                        recommendationsDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>All systems optimal';
                        recommendationsDiv.className = 'alert alert-success';
                    }
                }
            } catch (error) {
                console.error('Error loading Gemini usage:', error);
                // Show error state (XSS-safe)
                document.getElementById('currentModel').textContent = 'Error';
                document.getElementById('currentModel').className = 'badge bg-danger ms-2';
                // Show error state securely
                const errorDiv = document.getElementById('usageRecommendations');
                errorDiv.textContent = '';
                
                const errorIcon = document.createElement('i');
                errorIcon.className = 'fas fa-exclamation-triangle me-2';
                errorDiv.appendChild(errorIcon);
                errorDiv.appendChild(document.createTextNode('Unable to load usage data'));
                document.getElementById('usageRecommendations').className = 'alert alert-warning';
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toLocaleString();
        }

        function getUsageProgressClass(percentage) {
            if (percentage >= 90) return 'bg-danger';
            if (percentage >= 75) return 'bg-warning';
            if (percentage >= 50) return 'bg-info';
            return 'bg-success';
        }

        function getRecommendationClass(recommendation) {
            if (recommendation.includes('⚠️') || recommendation.includes('Approaching')) {
                return 'alert alert-warning';
            } else if (recommendation.includes('💡') || recommendation.includes('High')) {
                return 'alert alert-info';
            } else if (recommendation.includes('🔄') || recommendation.includes('switched')) {
                return 'alert alert-secondary';
            } else if (recommendation.includes('💰') || recommendation.includes('savings')) {
                return 'alert alert-success';
            }
            return 'alert alert-info';
        }

        // Auto-refresh every 5 minutes
        setInterval(function() {
            if (document.getElementById('dashboard').style.display !== 'none') {
                loadDashboardData();
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>