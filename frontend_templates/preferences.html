<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Preferences - ML Training</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="/static/css/unified-theme.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        .scenario-manager {
            background: var(--bs-gray-100);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .scenario-card {
            background: var(--bs-gray-200);
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .variable-group {
            background: var(--bs-gray-100);
            border: 1px solid var(--bs-border-color);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .variable-group summary {
            cursor: pointer;
            font-weight: 600;
            padding: 0.5rem;
            user-select: none;
        }

        .variable-group[open] summary {
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--bs-border-color);
        }

        .acceptance-score-section {
            background: linear-gradient(135deg, var(--bs-success), var(--bs-info));
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
            color: white;
        }

        .score-display {
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            margin: 1rem 0;
        }

        .score-gradient {
            height: 20px;
            background: linear-gradient(to right,
                #dc3545 0%,
                #fd7e14 25%,
                #ffc107 50%,
                #28a745 75%,
                #1e7e34 100%);
            border-radius: 10px;
            margin-top: 0.5rem;
        }

        .visualization-panel {
            position: sticky;
            top: 20px;
        }

        .model-status {
            background: var(--bs-gray-200);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
        }

        .status-badge.trained {
            background: var(--bs-success);
            color: white;
        }

        .status-badge.untrained {
            background: var(--bs-danger);
            color: white;
        }

        .formula-display {
            background: var(--bs-dark);
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            padding: 1.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .decision-badge {
            text-align: center;
            padding: 1.5rem;
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 1rem 0;
        }

        .decision-badge.apply {
            background: var(--bs-success);
            color: white;
        }

        .decision-badge.skip {
            background: var(--bs-danger);
            color: white;
        }

        .range-value {
            display: inline-block;
            min-width: 40px;
            text-align: center;
            font-weight: 600;
        }

        .chart-container {
            background: var(--bs-gray-200);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .btn-scenario-action {
            margin: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        {% include 'shared_navigation.html' %}

        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="mb-2">
                    <i class="fas fa-brain me-3"></i>User Preferences - ML Training
                </h1>
                <p class="text-muted">
                    Define 1-5 job scenarios to train a machine learning model that predicts job acceptance
                </p>
            </div>
        </div>

        <div class="row">
            <!-- Left Panel: Scenario Manager (60%) -->
            <div class="col-lg-7">
                <div class="scenario-manager">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>Job Scenarios</h3>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="addScenario()" id="btnAddScenario">
                                <i class="fas fa-plus"></i> Add Scenario
                            </button>
                            <button class="btn btn-sm btn-success" onclick="saveScenarios()">
                                <i class="fas fa-save"></i> Save All
                            </button>
                        </div>
                    </div>

                    <!-- Scenarios Container -->
                    <div id="scenariosContainer">
                        <!-- Scenarios will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <!-- Right Panel: Training & Visualization (40%) -->
            <div class="col-lg-5">
                <div class="visualization-panel">

                    <!-- Model Status & Training -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0">Model Status</h5>
                        </div>
                        <div class="card-body">
                            <div class="model-status">
                                <div id="modelStatus" class="status-badge untrained">
                                    ❌ Not Trained
                                </div>
                                <div id="modelMetadata" class="mt-2 text-muted" style="display: none;">
                                    <small id="modelDetails"></small>
                                </div>
                            </div>

                            <button id="btnTrainModel" class="btn btn-primary w-100 mt-3" onclick="trainModel()" disabled>
                                <i class="fas fa-cog"></i> Train Model
                            </button>

                            <div id="formulaContainer" style="display: none;">
                                <h6 class="mt-3">Learned Formula</h6>
                                <div class="formula-display" id="formulaText">
                                    <!-- Formula will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Importance -->
                    <div class="card mb-3" id="featureImportanceCard" style="display: none;">
                        <div class="card-header">
                            <h5 class="mb-0">What Matters Most</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="featureChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Trade-off Visualization -->
                    <div class="card mb-3" id="tradeoffCard" style="display: none;">
                        <div class="card-header">
                            <h5 class="mb-0">Trade-off Explorer</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label">X-Axis:</label>
                                    <select class="form-select form-select-sm" id="xAxisFactor" onchange="updateTradeoffChart()">
                                        <option value="salary">Salary</option>
                                        <option value="commute_time_minutes">Commute Time</option>
                                        <option value="work_hours_per_week">Work Hours</option>
                                        <option value="career_growth">Career Growth</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Y-Axis:</label>
                                    <select class="form-select form-select-sm" id="yAxisFactor" onchange="updateTradeoffChart()">
                                        <option value="commute_time_minutes">Commute Time</option>
                                        <option value="salary">Salary</option>
                                        <option value="work_hours_per_week">Work Hours</option>
                                        <option value="career_growth">Career Growth</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="tradeoffChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Job Preview -->
                    <div class="card" id="jobPreviewCard" style="display: none;">
                        <div class="card-header">
                            <h5 class="mb-0">Test Your Model</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small">Enter hypothetical job details to see if your model would recommend applying</p>

                            <div class="mb-2">
                                <label class="form-label">Salary</label>
                                <input type="number" class="form-control form-control-sm" id="testSalary" placeholder="e.g., 75000">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Commute (minutes)</label>
                                <input type="number" class="form-control form-control-sm" id="testCommute" placeholder="e.g., 20">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Work Hours/Week</label>
                                <input type="number" class="form-control form-control-sm" id="testHours" placeholder="e.g., 40">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Career Growth (1-10)</label>
                                <input type="range" class="form-range" id="testCareerGrowth" min="1" max="10" value="5">
                                <span class="range-value" id="testCareerGrowthValue">5</span>
                            </div>

                            <button class="btn btn-primary w-100" onclick="evaluateTestJob()">
                                <i class="fas fa-chart-line"></i> Evaluate Job
                            </button>

                            <div id="evaluationResults" style="display: none;" class="mt-3">
                                <div class="decision-badge" id="decisionBadge">
                                    <!-- Decision will be inserted here -->
                                </div>
                                <div class="score-display" id="scoreDisplay" style="font-size: 2rem;">
                                    <!-- Score will be inserted here -->
                                </div>
                                <div class="text-center">
                                    <small class="text-muted">Confidence: <span id="confidenceValue"></span>%</small>
                                </div>
                                <div id="explanationText" class="mt-3">
                                    <!-- Explanation will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global state
        let scenarios = [];
        let nextScenarioId = 1;
        let featureChart = null;
        let tradeoffChart = null;

        // Variable definitions (26 total)
        const VARIABLES = {
            core: [
                {name: 'salary', label: 'Salary ($)', type: 'number', placeholder: '75000'},
                {name: 'commute_time_minutes', label: 'Commute (minutes)', type: 'number', placeholder: '20'},
                {name: 'work_hours_per_week', label: 'Work Hours/Week', type: 'number', placeholder: '40'},
                {name: 'work_arrangement', label: 'Work Arrangement', type: 'select', options: [
                    {value: 1, label: 'Onsite'},
                    {value: 2, label: 'Hybrid'},
                    {value: 3, label: 'Remote'}
                ]},
                {name: 'career_growth', label: 'Career Growth', type: 'range', min: 1, max: 10, default: 5}
            ],
            characteristics: [
                {name: 'job_stress', label: 'Job Stress (lower better)', type: 'range', min: 1, max: 10, default: 5},
                {name: 'mission_match', label: 'Mission Match', type: 'range', min: 1, max: 10, default: 5},
                {name: 'industry_preference', label: 'Industry Preference', type: 'range', min: 1, max: 10, default: 5},
                {name: 'job_title_match', label: 'Job Title Match', type: 'range', min: 1, max: 10, default: 5},
                {name: 'company_prestige', label: 'Company Prestige', type: 'range', min: 1, max: 10, default: 5}
            ],
            benefits: [
                {name: 'work_hour_flexibility', label: 'Work Hour Flexibility', type: 'range', min: 1, max: 10, default: 5},
                {name: 'vacation_days', label: 'Vacation Days', type: 'number', placeholder: '15'},
                {name: 'benefits_quality', label: 'Benefits Quality', type: 'range', min: 1, max: 10, default: 5}
            ]
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadExistingScenarios();
            loadModelInfo();

            // Update range display
            document.getElementById('testCareerGrowth').addEventListener('input', function() {
                document.getElementById('testCareerGrowthValue').textContent = this.value;
            });
        });

        // Add new scenario
        function addScenario() {
            if (scenarios.length >= 5) {
                alert('Maximum 5 scenarios allowed');
                return;
            }

            const scenario = {
                id: nextScenarioId++,
                scenario_name: `Scenario ${scenarios.length + 1}`,
                acceptance_score: 50,
                variables: {}
            };

            scenarios.push(scenario);
            renderScenarios();
            updateTrainButton();
        }

        // Remove scenario
        function removeScenario(id) {
            scenarios = scenarios.filter(s => s.id !== id);
            renderScenarios();
            updateTrainButton();
        }

        // Render all scenarios
        function renderScenarios() {
            const container = document.getElementById('scenariosContainer');

            if (scenarios.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>No scenarios defined yet. Click "Add Scenario" to start.</p>
                    </div>
                `;
                document.getElementById('btnAddScenario').disabled = false;
                return;
            }

            container.innerHTML = scenarios.map(scenario => `
                <div class="scenario-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <input type="text" class="form-control" style="max-width: 300px;"
                               value="${scenario.scenario_name}"
                               onchange="updateScenarioName(${scenario.id}, this.value)"
                               placeholder="Scenario Name">
                        <button class="btn btn-sm btn-outline-danger" onclick="removeScenario(${scenario.id})">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>

                    <!-- Core Variables -->
                    <div class="variable-group">
                        <h6>Essential Variables</h6>
                        ${renderVariableInputs(scenario, VARIABLES.core)}
                    </div>

                    <!-- Advanced Variables (Collapsible) -->
                    <details class="variable-group">
                        <summary>Job Characteristics (5 variables)</summary>
                        ${renderVariableInputs(scenario, VARIABLES.characteristics)}
                    </details>

                    <details class="variable-group">
                        <summary>Benefits & Work-Life (3 variables)</summary>
                        ${renderVariableInputs(scenario, VARIABLES.benefits)}
                    </details>

                    <!-- Acceptance Score (Most Important!) -->
                    <div class="acceptance-score-section">
                        <h6>⭐ How acceptable is this job?</h6>
                        <input type="range" class="form-range" min="0" max="100"
                               value="${scenario.acceptance_score}"
                               oninput="updateAcceptanceScore(${scenario.id}, this.value)">
                        <div class="score-display" id="score-${scenario.id}">${scenario.acceptance_score}/100</div>
                        <div class="score-gradient"></div>
                    </div>
                </div>
            `).join('');

            document.getElementById('btnAddScenario').disabled = scenarios.length >= 5;
        }

        // Render variable inputs
        function renderVariableInputs(scenario, variables) {
            return variables.map(v => {
                const value = scenario.variables[v.name] || v.default || '';

                if (v.type === 'number') {
                    return `
                        <div class="mb-2">
                            <label class="form-label small">${v.label}</label>
                            <input type="number" class="form-control form-control-sm"
                                   placeholder="${v.placeholder || ''}"
                                   value="${value}"
                                   onchange="updateVariable(${scenario.id}, '${v.name}', this.value)">
                        </div>
                    `;
                } else if (v.type === 'range') {
                    return `
                        <div class="mb-2">
                            <label class="form-label small">${v.label}</label>
                            <div class="d-flex align-items-center">
                                <input type="range" class="form-range me-2" min="${v.min}" max="${v.max}"
                                       value="${value}"
                                       oninput="updateVariable(${scenario.id}, '${v.name}', this.value); this.nextElementSibling.textContent = this.value">
                                <span class="range-value">${value}</span>
                            </div>
                        </div>
                    `;
                } else if (v.type === 'select') {
                    return `
                        <div class="mb-2">
                            <label class="form-label small">${v.label}</label>
                            <select class="form-select form-select-sm"
                                    onchange="updateVariable(${scenario.id}, '${v.name}', this.value)">
                                ${v.options.map(opt => `
                                    <option value="${opt.value}" ${value == opt.value ? 'selected' : ''}>
                                        ${opt.label}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    `;
                }
            }).join('');
        }

        // Update scenario name
        function updateScenarioName(id, name) {
            const scenario = scenarios.find(s => s.id === id);
            if (scenario) scenario.scenario_name = name;
        }

        // Update variable value
        function updateVariable(id, name, value) {
            const scenario = scenarios.find(s => s.id === id);
            if (scenario) {
                scenario.variables[name] = parseFloat(value) || value;
            }
        }

        // Update acceptance score
        function updateAcceptanceScore(id, value) {
            const scenario = scenarios.find(s => s.id === id);
            if (scenario) {
                scenario.acceptance_score = parseInt(value);
                document.getElementById(`score-${id}`).textContent = `${value}/100`;
            }
        }

        // Update train button state
        function updateTrainButton() {
            const btn = document.getElementById('btnTrainModel');
            btn.disabled = scenarios.length === 0;
        }

        // Save scenarios to backend
        async function saveScenarios() {
            if (scenarios.length === 0) {
                alert('No scenarios to save');
                return;
            }

            const scenarioData = scenarios.map(s => ({
                scenario_name: s.scenario_name,
                acceptance_score: s.acceptance_score,
                ...s.variables
            }));

            try {
                const response = await fetch('/preferences/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: 'steve_glen',
                        scenarios: scenarioData
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('✓ Scenarios saved successfully!', 'success');
                    updateTrainButton();
                } else {
                    showToast('Error: ' + data.error, 'danger');
                }
            } catch (error) {
                showToast('Error saving scenarios: ' + error.message, 'danger');
            }
        }

        // Train model
        async function trainModel() {
            const btn = document.getElementById('btnTrainModel');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Training...';

            try {
                const response = await fetch('/preferences/train', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: 'steve_glen'})
                });

                const data = await response.json();

                if (data.success) {
                    showToast('✓ Model trained successfully!', 'success');

                    // Update UI
                    updateModelStatus(data);
                    displayFormula(data.formula);
                    displayFeatureImportance(data.training_result.feature_importance);

                    // Show visualization panels
                    document.getElementById('featureImportanceCard').style.display = 'block';
                    document.getElementById('tradeoffCard').style.display = 'block';
                    document.getElementById('jobPreviewCard').style.display = 'block';

                    btn.innerHTML = '<i class="fas fa-cog"></i> Retrain Model';
                } else {
                    showToast('Error: ' + data.error, 'danger');
                    btn.innerHTML = '<i class="fas fa-cog"></i> Train Model';
                }
            } catch (error) {
                showToast('Error training model: ' + error.message, 'danger');
                btn.innerHTML = '<i class="fas fa-cog"></i> Train Model';
            } finally {
                btn.disabled = false;
            }
        }

        // Update model status display
        function updateModelStatus(data) {
            const badge = document.getElementById('modelStatus');
            badge.className = 'status-badge trained';
            badge.textContent = '✅ Model Trained';

            const metadata = document.getElementById('modelMetadata');
            metadata.style.display = 'block';

            const details = document.getElementById('modelDetails');
            const result = data.training_result;
            details.innerHTML = `
                Model: ${result.model_type}<br>
                R² Score: ${result.train_r2?.toFixed(3) || 'N/A'}<br>
                Scenarios: ${result.scenario_count || scenarios.length}
            `;
        }

        // Display formula
        function displayFormula(formula) {
            document.getElementById('formulaContainer').style.display = 'block';
            document.getElementById('formulaText').textContent = formula;
        }

        // Display feature importance
        function displayFeatureImportance(importance) {
            const ctx = document.getElementById('featureChart').getContext('2d');

            if (featureChart) {
                featureChart.destroy();
            }

            const labels = Object.keys(importance);
            const values = Object.values(importance);

            featureChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Importance (%)',
                        data: values,
                        backgroundColor: '#4a90e2'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Evaluate test job
        async function evaluateTestJob() {
            const jobData = {
                salary: parseFloat(document.getElementById('testSalary').value) || 0,
                commute_time_minutes: parseFloat(document.getElementById('testCommute').value) || 0,
                work_hours_per_week: parseFloat(document.getElementById('testHours').value) || 40,
                career_growth: parseInt(document.getElementById('testCareerGrowth').value) || 5
            };

            try {
                const response = await fetch('/preferences/evaluate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: 'steve_glen',
                        job: jobData
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayEvaluation(data.evaluation);
                } else {
                    showToast('Error: ' + data.error, 'danger');
                }
            } catch (error) {
                showToast('Error evaluating job: ' + error.message, 'danger');
            }
        }

        // Display evaluation results
        function displayEvaluation(evaluation) {
            document.getElementById('evaluationResults').style.display = 'block';

            const badge = document.getElementById('decisionBadge');
            badge.className = evaluation.should_apply ? 'decision-badge apply' : 'decision-badge skip';
            badge.textContent = evaluation.should_apply ? '✅ APPLY' : '❌ SKIP';

            document.getElementById('scoreDisplay').textContent = `${evaluation.acceptance_score}/100`;
            document.getElementById('confidenceValue').textContent = evaluation.confidence;

            const explanation = document.getElementById('explanationText');
            explanation.innerHTML = `<h6>Explanation:</h6><p class="small">${evaluation.explanation}</p>`;
        }

        // Load existing scenarios from backend
        async function loadExistingScenarios() {
            try {
                const response = await fetch('/preferences/scenarios?user_id=steve_glen');
                const data = await response.json();

                if (data.success && data.scenarios.length > 0) {
                    scenarios = data.scenarios.map((s, i) => ({
                        id: i + 1,
                        scenario_name: s.scenario_name,
                        acceptance_score: s.acceptance_score,
                        variables: Object.fromEntries(
                            Object.entries(s).filter(([k]) =>
                                !['scenario_id', 'scenario_name', 'acceptance_score', 'created_at', 'updated_at'].includes(k)
                            )
                        )
                    }));
                    nextScenarioId = scenarios.length + 1;
                    renderScenarios();
                    updateTrainButton();
                } else {
                    // Add one default scenario to start
                    addScenario();
                }
            } catch (error) {
                console.error('Error loading scenarios:', error);
                addScenario();
            }
        }

        // Load model info
        async function loadModelInfo() {
            try {
                const response = await fetch('/preferences/model-info?user_id=steve_glen');
                const data = await response.json();

                if (data.success && data.trained) {
                    updateModelStatus(data);
                    displayFormula(data.formula);
                    displayFeatureImportance(data.feature_importance);

                    document.getElementById('featureImportanceCard').style.display = 'block';
                    document.getElementById('tradeoffCard').style.display = 'block';
                    document.getElementById('jobPreviewCard').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading model info:', error);
            }
        }

        // Update trade-off chart
        async function updateTradeoffChart() {
            const xFactor = document.getElementById('xAxisFactor').value;
            const yFactor = document.getElementById('yAxisFactor').value;

            if (!scenarios.length) {
                return;
            }

            const ctx = document.getElementById('tradeoffChart').getContext('2d');

            if (tradeoffChart) {
                tradeoffChart.destroy();
            }

            // Prepare scenario data points
            const scatterData = scenarios.map(s => ({
                x: s.variables[xFactor] || 0,
                y: s.variables[yFactor] || 0,
                acceptance: s.acceptance_score
            }));

            // Color points by acceptance score
            const pointColors = scatterData.map(p => {
                if (p.acceptance >= 80) return '#1e7e34';
                if (p.acceptance >= 60) return '#28a745';
                if (p.acceptance >= 40) return '#ffc107';
                if (p.acceptance >= 20) return '#fd7e14';
                return '#dc3545';
            });

            tradeoffChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'User Scenarios',
                        data: scatterData,
                        backgroundColor: pointColors,
                        borderColor: pointColors,
                        borderWidth: 2,
                        pointRadius: 8,
                        pointHoverRadius: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: formatVariableName(xFactor)
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: formatVariableName(yFactor)
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        `${formatVariableName(xFactor)}: ${point.x}`,
                                        `${formatVariableName(yFactor)}: ${point.y}`,
                                        `Acceptance: ${point.acceptance}/100`
                                    ];
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Format variable name for display
        function formatVariableName(name) {
            return name
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            // Create toast container if it doesn't exist
            let container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'position-fixed top-0 end-0 p-3';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
            }

            // Create toast element
            const toastId = 'toast-' + Date.now();
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', toastHTML);

            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 3000
            });
            toast.show();

            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        // Error handling wrapper
        async function handleApiCall(apiFunction, errorMessage) {
            try {
                return await apiFunction();
            } catch (error) {
                console.error(errorMessage, error);
                showToast(errorMessage + ': ' + error.message, 'danger');
                throw error;
            }
        }
    </script>
</body>
</html>
